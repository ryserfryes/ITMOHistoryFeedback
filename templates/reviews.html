{% extends 'base.html' %}
{% block content %}
<h1>–í—Å–µ –æ—Ç–∑—ã–≤—ã</h1>
<p>–í—Å–µ–≥–æ –æ—Ç–∑—ã–≤–æ–≤: <span id="reviews-count">{{ reviews_by_subject.values() | map('length') | sum }}</span></p>

<div class="row">
    <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: —Ñ–∏–ª—å—Ç—Ä—ã -->
    <div class="col-md-3 text-start">
        <strong>–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º:</strong>
        <div class="mt-2">
            <!-- –§–∏–ª—å—Ç—Ä—ã –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º –∏ –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—è–º -->
            {% for subject, lecturers in subjects_with_teachers.items() %}
            <div class="subject-group mb-4">
                <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–∞ -->
                <div class="fw-bold text-primary mb-2" style="font-size: 0.95em;">
                    {{ subject }}
                </div>
                
                <!-- –õ–µ–∫—Ç–æ—Ä—ã —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ -->
                {% for lecturer, lecturer_data in lecturers.items() %}
                <div class="lecturer-group mb-3 ms-2">
                    <div class="form-check">
                        <input class="form-check-input lecturer-filter" type="checkbox" 
                            id="lecturer-{{ subject|replace(' ', '_') }}-{{ loop.index }}"
                            value="{{ lecturer }}" checked>
                        <label class="form-check-label fw-bold" 
                            for="lecturer-{{ subject|replace(' ', '_') }}-{{ loop.index }}" 
                            style="font-size: 0.9em;">
                            {{ lecturer }}
                            <!-- –†–µ–π—Ç–∏–Ω–≥–∏ –ª–µ–∫—Ç–æ—Ä–∞ -->
                            {% if lecturer_data.stats.complexity or lecturer_data.stats.interest %}
                            <div class="text-muted small mt-1">
                                {% if lecturer_data.stats.complexity %}
                                <span title="–°–ª–æ–∂–Ω–æ—Å—Ç—å –ª–µ–∫—Ü–∏–π" style="cursor: help;">üíÄ: {{ lecturer_data.stats.complexity }}</span>
                                {% endif %}
                                {% if lecturer_data.stats.interest %}
                                <span title="–ò–Ω—Ç–µ—Ä–µ—Å –ª–µ–∫—Ü–∏–π" style="cursor: help;" class="ms-2">‚≠êÔ∏è: {{ lecturer_data.stats.interest }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </label>
                    </div>

                    <!-- –ü–æ–¥—Ñ–∏–ª—å—Ç—Ä—ã –ø–æ –ø—Ä–∞–∫—Ç–∏–∫–∞–º -->
                    <div class="ms-3 mt-1 practitioner-subfilters" data-lecturer="{{ lecturer }}">
                        <small class="text-muted"><strong>–ü—Ä–∞–∫—Ç–∏–∫–∏:</strong></small>
                        {% set outer_loop = loop %}
                        {% for practitioner in lecturer_data.practitioners %}
                        <div class="form-check form-check-sm">
                            <input class="form-check-input practitioner-filter" type="checkbox"
                                id="prac-{{ subject|replace(' ', '_') }}-{{ outer_loop.index }}-{{ loop.index }}" 
                                value="{{ practitioner }}"
                                data-lecturer="{{ lecturer }}" checked>
                            <label class="form-check-label text-muted small"
                                for="prac-{{ subject|replace(' ', '_') }}-{{ outer_loop.index }}-{{ loop.index }}">
                                {{ practitioner }}
                                <!-- –†–µ–π—Ç–∏–Ω–≥–∏ –ø—Ä–∞–∫—Ç–∏–∫–∞ –ø–æ –ø—Ä–∞–∫—Ç–∏–∫–∞–º -->
                                {% if teacher_stats[practitioner] %}
                                <div class="text-muted" style="font-size: 0.75em;">
                                    {% if teacher_stats[practitioner].practice_complexity %}
                                    <span title="–°–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∞–∫—Ç–∏–∫" style="cursor: help;">üíÄ: {{ teacher_stats[practitioner].practice_complexity }}</span>
                                    {% elif teacher_stats[practitioner].type == 'practitioner' and teacher_stats[practitioner].complexity %}
                                    <span title="–°–ª–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∞–∫—Ç–∏–∫" style="cursor: help;">üíÄ: {{ teacher_stats[practitioner].complexity }}</span>
                                    {% endif %}
                                    {% if teacher_stats[practitioner].practice_interest %}
                                    <span title="–ò–Ω—Ç–µ—Ä–µ—Å –ø—Ä–∞–∫—Ç–∏–∫" style="cursor: help;" class="ms-1">‚≠êÔ∏è: {{ teacher_stats[practitioner].practice_interest }}</span>
                                    {% elif teacher_stats[practitioner].type == 'practitioner' and teacher_stats[practitioner].interest %}
                                    <span title="–ò–Ω—Ç–µ—Ä–µ—Å –ø—Ä–∞–∫—Ç–∏–∫" style="cursor: help;" class="ms-1">‚≠êÔ∏è: {{ teacher_stats[practitioner].interest }}</span>
                                    {% endif %}
                                </div>
                                {% endif %}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –æ—Ç–∑—ã–≤—ã -->
    <div class="col-md-9">
        <div id="reviews-container">
            {% set review_counter = namespace(value=0) %}
            {% for subject, reviews in reviews_by_subject.items() %}
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–∞ -->
            <div class="subject-header mb-3">
                <h3 class="text-primary border-bottom pb-2">{{ subject }}</h3>
            </div>
            
            {% for review in reviews %}
            {% set review_counter.value = review_counter.value + 1 %}
            <div class="card mb-3 review-item" data-lecturer="{{ review.lecturer }}"
                data-practitioner="{{ review.practitioner }}" data-subject="{{ review.subject }}">
                <div class="card-header">
                    <button class="btn btn-link text-decoration-none p-0 w-100 text-start" type="button"
                        data-bs-toggle="collapse" data-bs-target="#review-{{ review_counter.value }}" aria-expanded="true"
                        aria-controls="review-{{ review_counter.value }}">
                        <strong>–û—Ç–∑—ã–≤ {{ review_counter.value }}</strong>
                        <span class="float-end collapse-indicator">‚àí</span>
                    </button>
                </div>
                <div id="review-{{ review_counter.value }}" class="collapse show">
                    <div class="card-body">
                        <!-- –û –ª–µ–∫—Ü–∏—è—Ö -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">–û –ª–µ–∫—Ü–∏—è—Ö:</h5>
                                <div class="text-end">
                                    {% if review.lectures.complexity != '‚Äî' %}
                                    <span class="me-3"><strong>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</strong> {{ review.lectures.complexity }}</span>
                                    {% endif %}
                                    {% if review.lectures.interest != '‚Äî' %}
                                    <span><strong>–ò–Ω—Ç–µ—Ä–µ—Å:</strong> {{ review.lectures.interest }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% if review.lectures.feedback != '‚Äî' %}
                            <p class="text-muted text-justify" style="text-align: justify; white-space: pre-line;">{{
                                review.lectures.feedback }}</p>
                            {% else %}
                            <p class="text-muted fst-italic">–û—Ç–∑—ã–≤ –Ω–µ –æ—Å—Ç–∞–≤–ª–µ–Ω</p>
                            {% endif %}
                            <small class="text-secondary"><strong>–õ–µ–∫—Ç–æ—Ä:</strong> {{ review.lecturer }}</small>
                        </div>

                        <!-- –û –ø—Ä–∞–∫—Ç–∏–∫–∞—Ö -->
                        <div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">–û –ø—Ä–∞–∫—Ç–∏–∫–∞—Ö:</h5>
                                <div class="text-end">
                                    {% if review.practices.complexity != '‚Äî' %}
                                    <span class="me-3"><strong>–°–ª–æ–∂–Ω–æ—Å—Ç—å:</strong> {{ review.practices.complexity }}</span>
                                    {% endif %}
                                    {% if review.practices.interest != '‚Äî' %}
                                    <span><strong>–ò–Ω—Ç–µ—Ä–µ—Å:</strong> {{ review.practices.interest }}</span>
                                    {% endif %}
                                </div>
                            </div>
                            {% if review.practices.feedback != '‚Äî' %}
                            <p class="text-muted text-justify" style="text-align: justify; white-space: pre-line;">{{
                                review.practices.feedback }}</p>
                            {% else %}
                            <p class="text-muted fst-italic">–û—Ç–∑—ã–≤ –Ω–µ –æ—Å—Ç–∞–≤–ª–µ–Ω</p>
                            {% endif %}
                            <small class="text-secondary"><strong>–ü—Ä–∞–∫—Ç–∏–∫:</strong> {{ review.practitioner }}</small>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const lecturerFilters = document.querySelectorAll('.lecturer-filter');
        const practitionerFilters = document.querySelectorAll('.practitioner-filter');
        const reviewItems = document.querySelectorAll('.review-item');

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏—è
        const collapseElements = document.querySelectorAll('[data-bs-toggle="collapse"]');

        collapseElements.forEach(button => {
            const targetId = button.getAttribute('data-bs-target');
            const target = document.querySelector(targetId);
            const indicator = button.querySelector('.collapse-indicator');

            target.addEventListener('show.bs.collapse', function () {
                indicator.textContent = '‚àí';
            });

            target.addEventListener('hide.bs.collapse', function () {
                indicator.textContent = '+';
            });
        });

        // –§—É–Ω–∫—Ü–∏—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –æ—Ç–∑—ã–≤–æ–≤
        function filterReviews() {
            // –°–æ–±–∏—Ä–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ª–µ–∫—Ç–æ—Ä–æ–≤ –∏ –∏—Ö –ø—Ä–∞–∫—Ç–∏–∫–æ–≤
            const selectedFilters = new Map();

            lecturerFilters.forEach(lecturerFilter => {
                if (lecturerFilter.checked) {
                    const lecturerName = lecturerFilter.value;
                    const lecturerPractitioners = [];

                    // –ù–∞—Ö–æ–¥–∏–º –ø—Ä–∞–∫—Ç–∏–∫–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –ª–µ–∫—Ç–æ—Ä–∞
                    const practitionerSubfilters = document.querySelectorAll(
                        `.practitioner-filter[data-lecturer="${lecturerName}"]`
                    );

                    practitionerSubfilters.forEach(pracFilter => {
                        if (pracFilter.checked) {
                            lecturerPractitioners.push(pracFilter.value);
                        }
                    });

                    if (lecturerPractitioners.length > 0) {
                        selectedFilters.set(lecturerName, lecturerPractitioners);
                    }
                }
            });

            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∫ –æ—Ç–∑—ã–≤–∞–º
            const subjectHeaders = document.querySelectorAll('.subject-header');
            const subjectsWithVisibleReviews = new Set();
            let visibleReviewsCount = 0;

            reviewItems.forEach(item => {
                const itemLecturer = item.dataset.lecturer;
                const itemPractitioner = item.dataset.practitioner;
                const itemSubject = item.dataset.subject;

                let shouldShow = false;

                if (selectedFilters.has(itemLecturer)) {
                    const allowedPractitioners = selectedFilters.get(itemLecturer);
                    if (allowedPractitioners.includes(itemPractitioner)) {
                        shouldShow = true;
                        subjectsWithVisibleReviews.add(itemSubject);
                        visibleReviewsCount++;
                    }
                }

                item.style.display = shouldShow ? 'block' : 'none';
            });

            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
            subjectHeaders.forEach(header => {
                const subjectName = header.querySelector('h3').textContent.trim();
                header.style.display = subjectsWithVisibleReviews.has(subjectName) ? 'block' : 'none';
            });

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—Ç–∑—ã–≤–æ–≤
            document.getElementById('reviews-count').textContent = visibleReviewsCount;
        }



        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ª–µ–∫—Ç–æ—Ä–æ–≤
        lecturerFilters.forEach(lecturerFilter => {
            lecturerFilter.addEventListener('change', function () {
                if (this.checked) {
                    // –í–∫–ª—é—á–∞–µ–º –≤—Å–µ—Ö –ø—Ä–∞–∫—Ç–∏–∫–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –ª–µ–∫—Ç–æ—Ä–∞
                    const lecturerName = this.value;
                    const practitionerSubfilters = document.querySelectorAll(
                        `.practitioner-filter[data-lecturer="${lecturerName}"]`
                    );
                    practitionerSubfilters.forEach(filter => filter.checked = true);
                } else {
                    // –í—ã–∫–ª—é—á–∞–µ–º –≤—Å–µ—Ö –ø—Ä–∞–∫—Ç–∏–∫–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –ª–µ–∫—Ç–æ—Ä–∞
                    const lecturerName = this.value;
                    const practitionerSubfilters = document.querySelectorAll(
                        `.practitioner-filter[data-lecturer="${lecturerName}"]`
                    );
                    practitionerSubfilters.forEach(filter => filter.checked = false);
                }
                filterReviews();
            });
        });

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤ –ø—Ä–∞–∫—Ç–∏–∫–æ–≤
        practitionerFilters.forEach(practitionerFilter => {
            practitionerFilter.addEventListener('change', function () {
                const lecturerName = this.dataset.lecturer;
                const lecturerFilter = document.querySelector(`.lecturer-filter[value="${lecturerName}"]`);

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–∞–∫—Ç–∏–∫ —É —ç—Ç–æ–≥–æ –ª–µ–∫—Ç–æ—Ä–∞
                const practitionerSubfilters = document.querySelectorAll(
                    `.practitioner-filter[data-lecturer="${lecturerName}"]`
                );
                const hasSelectedPractitioner = Array.from(practitionerSubfilters).some(filter => filter.checked);

                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —á–µ–∫–±–æ–∫—Å–∞ –ª–µ–∫—Ç–æ—Ä–∞
                lecturerFilter.checked = hasSelectedPractitioner;

                filterReviews();
            });
        });

        // –ò–Ω–∏—Ü–∏–∞–ª—å–Ω–∞—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è
        filterReviews();
    });
</script>
{% endblock %}